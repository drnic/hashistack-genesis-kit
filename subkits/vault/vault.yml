---
instance_groups:
- name: vault
  jobs:
  - { release: vault, name: vault }
  - release: consul
    name: consul
    consumes:
      consul_servers: { from: consul }
  instances: 2
  azs: (( grab params.availability_zones ))
  vm_type: (( grab params.vault_vm_type ))
  stemcell: default
  networks:
  - name: (( grab params.vault_network ))

properties:
  vault:
    tls:
      certificate: (( vault meta.vault "/vault/certs/server:combined" ))
      key: (( vault meta.vault "/vault/certs/server:key" ))
    storage:
      use_consul: true
      consul:
        tls:
          ca_certificate: (( vault meta.vault "/consul/certs/ca:certificate" ))
          certificate: (( vault meta.vault "/consul/certs/vault:certificate" ))
          key: (( vault meta.vault "/consul/certs/vault:key" ))
    update:
      step_down_token: (( grab params.vault_step_down_token ))
      unseal_keys: (( grab params.vault_unseal_keys ))

releases:
- (( append ))
- name: vault
  version: 0.6.0
  url: "https://bosh.io/d/github.com/cloudfoundry-community/vault-boshrelease?v=0.6.0"
  sha1: 67a1a46f95c73a25ab3590fdaf244e3b29835b83
