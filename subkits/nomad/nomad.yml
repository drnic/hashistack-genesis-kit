---
instance_groups:
- name: server
  jobs:
  - (( append ))
  - { release: nomad, name: nomad-server }
  properties:
    nomad:
      ssl_cert: (( vault meta.vault "/nomad/certs/server:certificate" ))
      ssl_key: (( vault meta.vault "/nomad/certs/server:key" ))

- name: node
  jobs:
  - { release: docker, name: docker }
  - { release: nomad, name: traefik }
  - { release: nomad, name: nomad-client }
  - release: consul
    name: consul
    consumes:
      consul_servers: { from: consul }
  instances: (( grab params.node_instances ))
  azs: (( grab params.availability_zones ))
  vm_type: (( grab params.node_vm_type ))
  stemcell: default
  networks:
  - name: (( grab params.node_network ))
  properties:
    # For docker
    tls_cacert: (( vault meta.vault "/docker/certs/ca:certificate" ))
    tls_cert: (( vault meta.vault "/docker/certs/daemon:certificate" ))
    tls_key: (( vault meta.vault "/docker/certs/daemon:key" ))
    traefik:
      ssl_cert: (( vault meta.vault "/traefik/certs/server:certificate" ))
      ssl_key: (( vault meta.vault "/traefik/certs/server:key" ))

properties:
  nomad:
    datacenter: (( grab params.datacenter ))
    region: (( grab params.region ))
    encrypt: (( vault meta.vault "/nomad/encrypt:key" ))
    ssl_ca: (( vault meta.vault "/nomad/certs/ca:certificate" ))
    ssl_cert: (( vault meta.vault "/nomad/certs/client:certificate" ))
    ssl_key: (( vault meta.vault "/nomad/certs/client:key" ))
    verify_server_hostname: (( grab params.verify_ssl ))
    consul:
      ssl_ca: (( vault meta.vault "/consul/certs/ca:certificate" ))
      ssl_cert: (( vault meta.vault "/consul/certs/nomad:certificate" ))
      ssl_key: (( vault meta.vault "/consul/certs/nomad:key" ))
    vault:
      ssl_ca: (( vault meta.vault "/vault/certs/ca:certificate" ))
      ssl_cert: (( vault meta.vault "/vault/certs/nomad:certificate" ))
      ssl_key: (( vault meta.vault "/vault/certs/nomad:key" ))
      create_from_role: (( grab params.nomad_vault_role ))
      token: (( vault meta.vault "/nomad/vault:token" ))

releases:
- (( append ))
- name: nomad
  version: 0.6.0
  url: "https://github.com/cloudfoundry-community/nomad-boshrelease/releases/download/v0.6.0/nomad-0.6.0.tgz"
- name: docker
  version: 30.1.3
  url: "https://github.com/cloudfoundry-community/docker-boshrelease/releases/download/v30.1.3/docker-30.1.3.tgz"
  sha1: bd6f68b9981453fbc72f50c15119f16663f27bad
