instance_groups:
- name: consul_server
  jobs:
  - release: consul
    name: consul
    provides:
      consul_servers: { as: consul }
    consumes:
      consul_servers: { from: consul }
  properties:
    consul:
      server: true
      ssl_cert: (( vault meta.vault "/consul/certs/server:certificate" ))
      ssl_key: (( vault meta.vault "/consul/certs/server:key" ))

  instances: (( grab params.server_instances ))
  azs: (( grab params.availability_zones ))
  persistent_disk_pool: (( grab params.consul_disk_pool ))
  vm_type: (( grab params.consul_vm_type ))
  stemcell: default
  networks:
  - name: (( grab params.consul_network ))

meta:
  vault: (( concat "secret/" params.vault ))

update:
  serial: true
  canaries: 1
  canary_watch_time: 30000-120000
  max_in_flight: 1
  update_watch_time: 30000-120000

properties:
  consul:
    server: false
    ssl_ca: (( vault meta.vault "/consul/certs/ca:certificate" ))
    ssl_cert: (( vault meta.vault "/consul/certs/agent:certificate" ))
    ssl_key: (( vault meta.vault "/consul/certs/agent:key" ))
    datacenter: (( grab params.datacenter ))
    leave_on_terminate: true
    verify_incoming: (( grab params.verify_ssl ))
    encrypt: (( vault meta.vault "/consul/encrypt:key" ))

releases:
- name: consul
  version: 23.0.1
  url: "https://bosh.io/d/github.com/cloudfoundry-community/consul-boshrelease?v=23.0.1"
  sha1: 04bbe700885bf1cfa774d6454058e4885fb142f3

stemcells:
- os: (( grab params.stemcell_os ))
  version: (( grab params.stemcell_version ))
  alias: default
