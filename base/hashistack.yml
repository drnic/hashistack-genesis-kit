instance_groups:
- name: consul_server
  jobs:
  - release: consul
    name: consul
    provides:
      consul_servers: { as: consul }
    consumes:
      consul_servers: { from: consul }
  properties:
    consul:
      ssl_ca: (( vault meta.vault "/consul/certs/ca:certificate" ))
      ssl_cert: (( vault meta.vault "/consul/certs/server:certificate" ))
      ssl_key: (( vault meta.vault "/consul/certs/server:key" ))

  instances: 3
  azs: (( grab params.availability_zones ))
  persistent_disk_pool: (( grab params.consul_disk_pool ))
  vm_type: (( grab params.consul_vm_type ))
  stemcell: default
  networks:
  - name: (( grab params.hashistack_network ))

meta:
  vault: (( concat "secret/" params.vault ))

update:
  serial: true
  canaries: 1
  canary_watch_time: 30000-120000
  max_in_flight: 1
  update_watch_time: 30000-120000

properties:
  consul:
    datacenter: (( grab params.datacenter ))
    leave_on_terminate: true
    verify_incoming: (( grab params.consul_verify_incoming ))
    encrypt: (( vault meta.vault "/consul/encrypt:key" ))

releases:
- name: consul
  version: 23.0.0
  url: "https://bosh.io/d/github.com/cloudfoundry-community/consul-boshrelease?v=23.0.0"
  sha1: 7ae648b284c92140b6aea44d0098b2e3ca3e5aa2

stemcells:
- os: (( grab params.stemcell_os ))
  version: (( grab params.stemcell_version ))
  alias: default
